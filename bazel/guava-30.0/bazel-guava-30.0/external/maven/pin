#!/usr/bin/env bash

set -euo pipefail
readonly maven_install_json_loc=$BUILD_WORKSPACE_DIRECTORY/maven_install.json
readonly execution_root=$(bazel info execution_root)
readonly workspace_name=$(basename $execution_root)
cat <<"RULES_JVM_EXTERNAL_EOF" | python -m json.tool > $maven_install_json_loc
{ "dependency_tree": {"conflict_resolution": {}, "dependencies": [{"coord": "com.google.code.findbugs:jsr305:3.0.2", "file": "v1/https/jcenter.bintray.com/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar", "directDependencies": [], "dependencies": [], "url": "https://jcenter.bintray.com/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar", "mirror_urls": ["https://jcenter.bintray.com/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar", "https://repo1.maven.org/maven2com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar"], "sha256": "766ad2a0783f2687962c8ad74ceecc38a28b9f72a2d085ee438b7813e928d0c7"}, {"coord": "com.google.errorprone:error_prone_annotations:2.4.0", "file": "v1/https/jcenter.bintray.com/com/google/errorprone/error_prone_annotations/2.4.0/error_prone_annotations-2.4.0.jar", "directDependencies": [], "dependencies": [], "url": "https://jcenter.bintray.com/com/google/errorprone/error_prone_annotations/2.4.0/error_prone_annotations-2.4.0.jar", "mirror_urls": ["https://jcenter.bintray.com/com/google/errorprone/error_prone_annotations/2.4.0/error_prone_annotations-2.4.0.jar", "https://repo1.maven.org/maven2com/google/errorprone/error_prone_annotations/2.4.0/error_prone_annotations-2.4.0.jar"], "sha256": "5f2a0648230a662e8be049df308d583d7369f13af683e44ddf5829b6d741a228"}, {"coord": "com.google.guava:failureaccess:1.0.1", "file": "v1/https/jcenter.bintray.com/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar", "directDependencies": [], "dependencies": [], "url": "https://jcenter.bintray.com/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar", "mirror_urls": ["https://jcenter.bintray.com/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar", "https://repo1.maven.org/maven2com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar"], "sha256": "a171ee4c734dd2da837e4b16be9df4661afab72a41adaf31eb84dfdaf936ca26"}, {"coord": "com.google.j2objc:j2objc-annotations:1.3", "file": "v1/https/jcenter.bintray.com/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar", "directDependencies": [], "dependencies": [], "url": "https://jcenter.bintray.com/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar", "mirror_urls": ["https://jcenter.bintray.com/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar", "https://repo1.maven.org/maven2com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar"], "sha256": "21af30c92267bd6122c0e0b4d20cccb6641a37eaf956c6540ec471d584e64a7b"}, {"coord": "org.checkerframework:checker-qual:3.7.0", "file": "v1/https/jcenter.bintray.com/org/checkerframework/checker-qual/3.7.0/checker-qual-3.7.0.jar", "directDependencies": [], "dependencies": [], "url": "https://jcenter.bintray.com/org/checkerframework/checker-qual/3.7.0/checker-qual-3.7.0.jar", "mirror_urls": ["https://jcenter.bintray.com/org/checkerframework/checker-qual/3.7.0/checker-qual-3.7.0.jar", "https://repo1.maven.org/maven2org/checkerframework/checker-qual/3.7.0/checker-qual-3.7.0.jar"], "sha256": "be2039732159d13f3f00867f22223992178a3b28b8a143724eba4206a8fdfff3"}], "version": "0.1.0", "__AUTOGENERATED_FILE_DO_NOT_MODIFY_THIS_FILE_MANUALLY": -1044457520}}
RULES_JVM_EXTERNAL_EOF

if [ "False" = "True" ]; then
    echo "Successfully pinned resolved artifacts for @maven, $maven_install_json_loc is now up-to-date."
else
    echo "Successfully pinned resolved artifacts for @maven in $maven_install_json_loc." \
      "This file should be checked in your version control system."
    echo
    echo "Next, please update your WORKSPACE file by adding the maven_install_json attribute" \
      "and loading pinned_maven_install from @maven//:defs.bzl".
    echo
    echo "For example:"
    echo
    cat <<EOF
=============================================================

maven_install(
    artifacts = # ...,
    repositories = # ...,
    maven_install_json = "@$workspace_name//:maven_install.json",
)

load("@maven//:defs.bzl", "pinned_maven_install")
pinned_maven_install()

=============================================================
EOF

    echo
    echo "To update maven_install.json, run this command to re-pin the unpinned repository:"
    echo
    echo "    bazel run @unpinned_maven//:pin"
fi
echo
